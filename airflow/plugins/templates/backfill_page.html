{% extends 'airflow/main.html' %}
{% block title %}Airflow - Backfill Plugin{% endblock %}
{% block head_css %}
{{ super() }}
{% endblock %}
{% block tail %}
<script>
   $(document).ready(function () {

   	const spinner_background_message = '<div class="alert alert-info" role="alert">Your job has been submitted successfully. It may take some time to trigger the dag instances. Check logs of your dag on Airflow UI as usual. </div>';

   	const background_message = function () {
   		$("#backfill_status").html(spinner_background_message)
   	};

   	const disable_form = function () {
   		$("#form :input").prop("disabled", true);
   	};

   	const enable_form = function () {
   		$("#form :input").prop("disabled", false);
   	};

   	$(document).on("submit", "#form", function (event) {
   		event.preventDefault();

   		const dag_name = $("#dag_name").val();
   		var today = new Date();
   		var today_date = today.getFullYear() + "-" + ("0"+(today.getMonth()+1)).slice(-2) + "-" + ("0" + today.getDate()).slice(-2) + "T" + ("0" + today.getHours()).slice(-2) + ":" + ("0" + today.getMinutes()).slice(-2);

   		const start_date = moment($("#start_date").val()).format('YYYY-MM-DDTHH:mm:00');
   		const end_date = moment($("#end_date").val()).format('YYYY-MM-DDTHH:mm:00');

   		const st_date = moment($("#start_date").val());
   		const en_date = moment($("#end_date").val());
   		const td_date = moment(today_date);

   		if (st_date > en_date) {
   			alert('Start date should be less than end date ');
   			return false;
   		}

   		if (en_date > st_date && en_date.diff(st_date, 'days') > 31) {
   			alert('Difference between start and end date should not exceed 30 days');
   			return false;
   		}

   		if (td_date < st_date || td_date < en_date ) {
   			alert("Start date and End date can't be greater than today's date");
   			return false;
   		}

   		// disable the form
   		disable_form()


		user_accepted = confirm("You have selected backfill for DAG name '" + dag_name + "'. Please click OK if DAG name is correct.");

		if (user_accepted === true) {
			const query_string = "?dag_name=" + dag_name + "&start_date=" + start_date + "&end_date=" + end_date;
			url = window.location.toString().split("/backfill")[0] + '/backfill/background' + query_string;
			// show background progress message

            background_message();

			$.get(url, function (data) {
				// enable the form
				enable_form()
			})
   			} else {
   				// diable the form
   				disable_form()
   			}
   	});

   	// tooltip
   	$('[data-toggle="tooltip"]').tooltip();
   });


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<style>
   /*Custom size for jumbotron*/
   .custom-jumbotron {
   height: 100px;
   padding: 10px;
   margin-bottom: 20px;
   }
   .row {
   margin-bottom: 10px;
   }
   .info-icon {
   font-weight: bolder;
   }
   #output {
   padding: 5px;
   background: #f7f7f7;
   height: 350px;
   overflow-y: scroll;
   }
   hr {
   margin-top: 1rem;
   margin-bottom: 1rem;
   border: 0;
   border-top: 1px solid rgba(0, 0, 0, 0.1);
   }
</style>
{% endblock %}
{% block body %}
{% if  rbac_authentication_enabled %}
{% block navbar %}
<header class="top" role="header">
   {% include 'appbuilder/navbar.html' %}
</header>
{% endblock %}
{%endif%}
<div class="container">
   <h2>Backfill</h2>
   <hr/>
   <!-- showing backfill status -->
   <div id="backfill_status"></div>
   <!-- start form -->
   <form id="form" autocomplete="off">
      <!-- dag related controls -->
      <div class="row">
         <div class="form-group col-md-8">
            <div class="form-group">
               <label for="dag_name">DAG Name</label>
               <input type="text" class="form-control" id="dag_name" name="dag_name" placeholder="place your dag name here" required="true">
            </div>
         </div>
         <div class="col-md-4">
            <div class="form-group">
               <label for="start_date">Start Datetime</label>
               <input type="datetime-local" name="start_date" class="form-control mb-2 mr-sm-2" id="start_date"
                  data-target="#start_date" required="true" />
            </div>
            <div class="form-group">
               <label for="end_date">End Datetime</label>
               <input type="datetime-local" name="end_date" class="form-control mb-2 mr-sm-2" id="end_date"
                  data-target="#end_date" required="true" />
            </div>
            <div class="form-group text-right">
               <input id="submit" type="submit" class="btn btn-primary mb-2 mr-sm-2" value="Start">
               <input type="reset" class="btn btn-default" value="Clear">
            </div>
         </div>
      </div>
   </form>
</div>
{% endblock %}